<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Panel</title>
<link rel="stylesheet" href="/style.css">
<style>
  .admin-container { max-width: 1000px; margin: auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 10px; text-align: left; word-break: break-word; }
  th { background-color: #f2f2f2; }
  button { margin-top: 10px; padding: 5px 10px; cursor: pointer; }
</style>
</head>
<body>
<div class="container admin-container">
  <h1>Admin Panel</h1>
  <button id="refresh">Refresh Messages</button>
  <button id="download">Download Messages</button>
  <table id="messagesTable">
    <thead>
      <tr>
        <th>Time</th>
        <th>User</th>
        <th>IP</th>
        <th>Message</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script type="module">
  const tableBody = document.querySelector("#messagesTable tbody");
  const refreshBtn = document.getElementById("refresh");
  const downloadBtn = document.getElementById("download");
  let messages = [];
  const user = prompt("Enter admin username:"); // only DEV can view

  // --- Fetch all messages ---
  async function loadMessages() {
    try {
      const res = await fetch(`/admin/messages?user=${user}`);
      messages = await res.json();
      renderMessages();
    } catch(e) {
      alert("Failed to load messages. Are you logged in as DEV?");
    }
  }

  function renderMessages() {
    tableBody.innerHTML = "";
    messages.forEach(m => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${new Date(m.timestamp).toLocaleString()}</td>
        <td>${m.username}</td>
        <td>${m.ip}</td>
        <td>${m.message}</td>
      `;
      tableBody.appendChild(tr);
    });
  }

  // --- Refresh manually ---
  refreshBtn.addEventListener("click", loadMessages);

  // --- Download JSON ---
  downloadBtn.addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(messages, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "messages.json";
    a.click();
    URL.revokeObjectURL(url);
  });

  // --- Real-time update via Socket.IO ---
  import { io } from "https://cdn.socket.io/4.7.2/socket.io.esm.min.js";
  const socket = io({ auth: { username: user } });

  socket.on("chat", msg => {
    messages.push(msg);
    renderMessages();
  });

  socket.on("whisper", msg => {
    messages.push({ ...msg, username: msg.from });
    renderMessages();
  });

  socket.on("system", msg => {
    messages.push({ username: "SYSTEM", ip: "-", message: msg, timestamp: Date.now() });
    renderMessages();
  });

  loadMessages();
</script>
</body>
</html>
